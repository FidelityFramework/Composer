# V-01: NIST SP 800-22 Validation

## Overview

NIST Special Publication 800-22 defines a statistical test suite for evaluating randomness of binary sequences. This document describes how QuantumCredential uses SP 800-22 to validate entropy quality and what the test results signify.

**Key Principle**: Statistical tests can detect non-randomness but cannot prove randomness. Passing SP 800-22 is necessary but not sufficient for cryptographic validity.

---

## For Software Engineers: What Testing Proves

A common misconception: "If it passes randomness tests, it is random."

The correct understanding: "If it fails randomness tests, it is definitely not random. If it passes, it might be random, or it might be a good PRNG."

SP 800-22 tests detect patterns that deviate from expected random behavior. A hardware TRNG like QuantumCredential should pass because it genuinely produces random output. A well-designed PRNG also passes because it is designed to mimic randomness.

The difference is *why* they pass:
- TRNG: Output is random because the physical process is random
- PRNG: Output appears random because the algorithm hides predictability

For QuantumCredential, SP 800-22 serves as a sanity check, not as proof of randomness. The proof comes from physics (avalanche noise is quantum) and mathematics (XOR preserves entropy). Testing confirms the implementation matches theory.

---

## The SP 800-22 Test Suite

### Test Categories

| Category | Tests | Purpose |
|----------|-------|---------|
| Frequency | Monobit, Block | Detect bias (ones vs zeros) |
| Runs | Runs, Longest Run | Detect patterns in consecutive values |
| Spectral | DFT | Detect periodic components |
| Template | Non-overlapping, Overlapping | Detect repeating patterns |
| Complexity | Universal, Complexity | Detect compressibility |
| Entropy | Approximate, Serial | Detect predictability |
| Random Walk | Cumulative Sums, Excursions | Detect drift |

### Individual Tests

**Frequency (Monobit) Test**
- Checks if number of ones and zeros is approximately equal
- Directly measures first-order bias
- QuantumCredential relevance: Our Îµ measurement is essentially this test

**Runs Test**
- Counts uninterrupted sequences of identical bits
- Detects local patterns
- QuantumCredential relevance: Independent samples should have random run lengths

**DFT (Spectral) Test**
- Applies Fourier transform to detect periodic patterns
- Reveals hidden oscillation
- QuantumCredential relevance: Detects any 60Hz pickup or clock-correlated noise

**Serial Test**
- Examines overlapping m-bit patterns
- Tests higher-order dependencies
- QuantumCredential relevance: Four-channel XOR should destroy correlations

**Approximate Entropy Test**
- Measures regularity by comparing pattern frequencies
- Lower entropy indicates predictability
- QuantumCredential relevance: Validates that XOR combination maximizes entropy

---

## Test Execution

### Minimum Data Requirements

| Test | Minimum bits | Recommended |
|------|--------------|-------------|
| Frequency | 100 | 1,000,000 |
| Runs | 100 | 1,000,000 |
| DFT | 1,000 | 1,000,000 |
| Serial | 256 | 1,000,000 |
| All tests | N/A | 1,000,000+ |

For comprehensive validation, generate 10-100 million bits and run the full suite.

### Test Procedure

```fsharp
/// Generate test data file
let generateTestData (outputPath: string) (bitCount: int) =
    use fs = File.Create outputPath
    let byteCount = bitCount / 8

    for _ in 1 .. byteCount do
        let b = generateEntropyByte()
        fs.WriteByte b

/// Run NIST test suite (external tool)
let runNistTests (dataPath: string) =
    // NIST STS tool invocation
    let args = sprintf "-file %s -tests all" dataPath
    Process.Start("assess", args)
```

### Interpreting Results

Each test produces a P-value:
- P < 0.01: Sequence is non-random at 99% confidence
- P > 0.01: Sequence is consistent with randomness

For multiple test runs, the proportion of passing sequences should be:
- Expected: ~99% pass (1% false positive rate)
- Concern: < 96% pass rate suggests issues
- Failure: < 90% pass rate indicates problem

---

## QuantumCredential-Specific Considerations

### Per-Channel Testing

Test each channel independently before XOR combination:

| Test Target | Expected Result | Significance |
|-------------|-----------------|--------------|
| Channel 0 alone | May show some bias | Raw entropy source |
| Channel 1 alone | May show some bias | Raw entropy source |
| Channel 2 alone | May show some bias | Raw entropy source |
| Channel 3 alone | May show some bias | Raw entropy source |
| Combined output | Should pass all tests | Bias reduction working |

Individual channels may marginally fail some tests (due to ~2-5% bias). The combined output must pass convincingly.

### Correlation Testing

SP 800-22 does not directly test cross-channel correlation. Add custom tests:

```fsharp
/// Test for cross-channel correlation
let testCorrelation (ch1: byte[]) (ch2: byte[]) =
    let xorBias = measureBias (Array.map2 (^^^) ch1 ch2)
    let expected = 2.0 * epsilon1 * epsilon2

    if abs (xorBias - expected) > 3.0 * statisticalError then
        Fail "Unexpected correlation between channels"
    else
        Pass
```

### Time-Series Analysis

SP 800-22 treats input as a static sequence. For continuous entropy generation, add:

**Trend detection**: Is bias changing over time?
```fsharp
let detectTrend (samples: float[]) =
    let slope = linearRegression samples
    if abs slope > threshold then
        Warning "Bias trending over time"
```

**Anomaly detection**: Are there sudden changes?
```fsharp
let detectAnomaly (samples: float[]) =
    let mean = Array.average samples
    let stddev = standardDeviation samples

    samples |> Array.iteri (fun i x ->
        if abs (x - mean) > 4.0 * stddev then
            Alert (sprintf "Anomaly at sample %d" i)
    )
```

---

## Test Automation

### Continuous Validation

Integrate SP 800-22 subset into runtime monitoring:

```fsharp
/// Lightweight runtime validation
let runtimeValidation (buffer: byte[]) =
    // Quick monobit test
    let ones = buffer |> Array.sumBy popcount
    let bits = buffer.Length * 8
    let bias = float ones / float bits - 0.5

    if abs bias > 0.01 then
        Alert "Bias exceeds threshold"

    // Quick runs test
    let runs = countRuns buffer
    let expectedRuns = bits / 2
    let runsDeviation = abs (float runs - float expectedRuns) / sqrt (float expectedRuns)

    if runsDeviation > 3.0 then
        Alert "Abnormal run distribution"
```

### Periodic Full Suite

Run complete SP 800-22 suite:
- During development: After any hardware or software change
- Production: Daily or after power cycle
- On demand: If runtime tests show warnings

---

## Documentation of Results

### Test Report Format

```markdown
# NIST SP 800-22 Test Report

## Test Configuration
- Date: 2026-01-24
- Hardware: YoshiPi Rev 1.0
- Firmware: v0.1.0
- Sample size: 100,000,000 bits

## Per-Channel Results

### Channel 0
| Test | P-value | Result |
|------|---------|--------|
| Frequency | 0.234 | PASS |
| Runs | 0.089 | PASS |
...

### Combined Output
| Test | P-value | Result |
|------|---------|--------|
| Frequency | 0.512 | PASS |
| Runs | 0.678 | PASS |
...

## Summary
- Tests passed: 188/188
- Pass rate: 100%
- Status: VALIDATED
```

### Archival

Store test results with:
- Git commit hash of firmware
- Hardware serial number
- Environmental conditions (temperature)
- Full raw data (compressed) for reproducibility

---

## Beyond SP 800-22

### Additional Standards

| Standard | Focus | When to Apply |
|----------|-------|---------------|
| SP 800-90B | Entropy estimation | Formal certification |
| AIS 31 | Hardware RNG evaluation | German/EU markets |
| FIPS 140-2/3 | Cryptographic module | Government contracts |

### Formal Certification Path

For production QuantumCredential:
1. SP 800-22 validation (internal)
2. SP 800-90B entropy assessment (internal)
3. Third-party AIS 31 evaluation
4. FIPS 140-3 module certification (if required)

---

## Connection to Other Documents

- **E-02-Epsilon-Evaluation**: Real-time bias measurement
- **M-02-Bias-Reduction-Analysis**: Theory behind expected test results
- **V-02-TRNG-Certification**: Broader certification context

---

## Summary

NIST SP 800-22 provides standardized statistical validation for entropy quality:

| Purpose | Method | Outcome |
|---------|--------|---------|
| Sanity check | Run full suite | Confirms implementation matches theory |
| Anomaly detection | Runtime subset | Catches degradation |
| Documentation | Archived reports | Audit trail for certification |

Passing SP 800-22 does not prove randomness; it confirms that the output exhibits no detectable patterns. For QuantumCredential, this confirms that the quantum physics (avalanche noise) and mathematics (XOR combination) are correctly implemented in hardware and software.
